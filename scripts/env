#!/usr/bin/env sh

. "$(dirname "$0")/utils.sh"

REPO_ROOT=$(git rev-parse --show-toplevel)
cd "$REPO_ROOT"

SUPPORTED_ENVS="prod dev"
env_file=".env"

load_env() {
    local env_file="$1"
    if [ -f "$env_file" ]; then
        # print the current env name
        export $(grep -v '^#' "$env_file" | xargs)
            return 0
        fi
    return 1
}

print_envs() {
    echo "This project supports the following environments:"
    for env in $SUPPORTED_ENVS;
    do
        echo "  $env"
    done
}

load_env "$env_file"; ENV_LOADED=$?

# handle runs with no argument provided
if [ -z "$1" ]; then

    if [ "$ENV_LOADED" -eq 0 ]; then
        echo $PROJECT_ENV
    else
        echo "No environment set."
        print_envs
    fi

    exit 0
fi

# handle runs with an argument provided
NEW_ENV="$1"
if in_array "$NEW_ENV" "$SUPPORTED_ENVS"; then
    if [ "$NEW_ENV" = "$PROJECT_ENV" ]; then
        echo "${NEW_ENV} is already active."
        exit 0
    fi

    # echo "$NEW_ENV" > "$env_file"
    echo "Setting environment to '$NEW_ENV'."
    exit 0
else
    echo "Unknown environment '"$NEW_ENV"'."
    print_envs
    exit 1
fi
